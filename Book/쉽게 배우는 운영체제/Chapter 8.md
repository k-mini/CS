
# 📚 가상 메모리의 기초

## 📌 가상 메모리의 개요

### 가상 메모리

- 크기가 다른 물리 메모리에서 일관되게 프로세스를 실행할 수 있는 기술
- 물리 메모리의 크기와 프로세스가 올라갈 메모리의 위치를 신경 쓰지않고 프로그래밍하도록 지원하는 메모리 시스템
- 물리 메모리의 크기와 상관없이 프로세스에 커다란 메모리 공간을 제공하는 기술

### 가상 메모리의 크기

- 이론적으로 가상 메모리는 무한대의 크기이다. 
- 가상 메모리에서 메모리 관리자가 사용할 수 있는 메모리의 전체 크기는 물리 메모리(실제 메모리)와 스왑 영역을 합친 크기이다. 
- 그러나 실제로 가상 메모리의 최대 크기는 그 컴퓨터 시스템이 가진 물리 메모리의 최대 크기로 한정
- 32bit CPU의 경우 32bit로 표현할 수 있는 최댓값인 2^32-1(16진수로 FFFFFFFF), 즉 4GB가 메모리의 최대 크기이고, 가상메모리의 최대 크기도 약 4GB이다.

### 동적 주소 변환

- 가상 메모리 시스템에서 메모리 관리자는 물리 메모리와 스왑 영역을 합쳐서 프로세스가 사용하는 가상 주소를 실제 메모리의 물리 주소로 변환하는 작업

### 가상 메모리와 물리 메모리

| 구분 | 가상 메모리 | 물리 메모리 |
| ---- | ----------- | ----------- |
| 최대 메모리 크기 | CPU의 비트 값에 의존 | CPU의 비트 값에 의존 |
| 메모리 분할 방식 | 세그먼테이션, 페이징, 세그먼테이션-페이징 혼용 기법 | 가변 분할 방식, 고정 분할 방식 |
| 주소 지정 방식 | 가상 주소 | 절대 주소, 상대 주소 |

### 매핑 테이블

- 메모리를 관리할 때, 매핑 테이블을 작성하여 관리 한다.
- 가상 메모리 시스템에서 가상 주소는 실제로 물리 주소나 스왑 영역 중 한 곳에 위치하며, 메모리 관리자는 가상 주소와 물리 주소를 일대일 매핑 테이블로 관리한다.


## 📌 페이징 기법

### 페이징 기법

- 고정 분할 방식을 이용한 가상 메모리 관리 기법으로, 물리 주소 공간을 같은 크기로 나누어 사용한다.
- 가상 주소는 프로세스 입장에서 바라본 메모리 공간으로 항상 0번지부터 시작한다.
- 가상 주소의 분할된 각 영역 => 페이지
- 물리 메모리의 각 영역 => 프레임
- 페이지와 프레임의 크기는 같다.

### 페이징 기법의 주소 변환 과정

- VA(가상주소) = <P,D> -> PA(물리주소 또는 실제주소) = <F,D>
- P = 나눗셈(가상 주소/한 페이지의 크기)의 몫
- D = 나눗셈(가상 주소/한 페이지의 크기)의 나머지

### 페이지 테이블

- 어떤 페이지가 어떤 프레임에 있는지에 대한 연결(매핑) 정보는 페이지 테이블에 담겨 있다.
- 각각의 한 줄은 페이지 테이블 엔트리(Page Table Entry, PTE)라고 부른다.
- 프로세스마다 페이지 테이블이 하나씩 있다.
- 메모리 관리자가 자주 사용하는 자료구조이므로 필요시 빨리 접근할 수 있어야 한다. 따라서 페이지 테이블은 물리 메모리 영역 중 운영체제 영역의 일부분에 모아 놓는다.
- 페이지 테이블의 시작 주소를 PCB의 페이지 테이블 기준 레지스터(Page Table Base Register,PTBR)에 보관한다.

### 직접 매핑

- 페이지 테이블 전체가 물리 메모리의 운영체제 영역에 존재
- 별다른 부가 작업 없이 바로 주소 변환이 가능

### 연관 매핑

- 페이지 테이블 전체가 스왑 영역에서 관리하는 방식
- 물리 메모리의 여유 공간이 작을 때 사용하는 방식
- 모든 페이지 테이블을 저장장치의 스왑 영역에 저장하고 그 중 일부(변환 색인 버퍼(TLB) 또는 연관 레지스터)만 물리 메모리에 가지고 있다.
- 주소 변환 시 직접 매핑은 원하는 프레임 번호를 한 번에 얻을 수 있지만 연관 매핑은 물리 메모리 내의 페이지 테이블을 다 검색해야 함
- 원하는 프레임 번호를 얻지 못하면 스왑 영역에 있는 페이지 테이블을 검색
- 원하는 페이지 번호가 메모리에 존재(TLB 히트)하면 곧바로 물리주소로 변환 없으면(TLB 미스) 스왑영역에 저장된 직접 매핑 테이블을 사용사여 변환

### 집합-연관 매핑 (디렉터리 매핑)

- 페이지 테이블을 일정한 집합으로 자르고 자른 덩어리 단위로 물리 메모리에 가져온다.
- 일정하게 자른 페이지 테이블이 물리 메모리에 있는지 스왑 영역에 있는지에 대한 위치 정보를 디렉터리 테이블로 표시한다.
- 원하는 페이지 테이블 엔트리가 스왑 영역에 있는지 물리 메모리에 있는지 간단히 파악할 수 있다. (TLB 히트 미스를 바로 파악, 연관 매핑은 물리메모리를 다 검사해야 알 수 있음)

### 역매핑

- 물리 메모리의 프레임 번호를 기준으로 테이블을 구성한다.
- 프로세스 수와 상관없이 테이블이 하나만 존재
- 테이블의 크기가 작지만 프로세스가 가상 메모리에 접근할 때 프로세스 아이디와 페이지 번호를 모두 찾아야 하는 단점이 있다.  
(연관 매핑처럼 페이지 테이블을 전부 검사해야 알 수 있음)


## 📌 세그먼테이션 기법

### 세그먼테이션

- 가변 분할 방식을 이용한 가상 메모리 관리 기법
- 물리 메모리를 프로세스의 크기에 따라 가변적으로 나누어 사용
- 장점 : 페이즈 테이블이 작고 단순
- 단점 : 외부 단편화로 인해서 물리 메모리 관리가 족잡하다.
- 
### 세그먼테이션 테이블

- 세그먼트의 크기를 나타내는 limit와 물리 메모리상의 시작 주소를 나타내는 address가 있다.
- 세그먼트가 자신에게 주어진 메모리 영역을 넘어가면 안되기 때문에 크기를 뜻하는 size 대신 제한을 뜻하는 limit을 사용
- 세그먼테이션 기법에도 물리 메모리가 부족할 때 스왑 영역을 사용한다. (스왑 영역이면 address에 I라고 표시)
- 사용하려면 세그먼트 영역을 벗어나면 트랩이 발생한다.
- 트랩은 자신의 영역을 벗어나는 주소에 접근하거나 숫자를 0으로 나누는 것과 같이 사용자가 의도치 않게 일으키는 인터럽트

## 📌 세그먼테이션-페이징 혼용 기법

### 메모리 접근 권한 검사

- 가상 주소에서 물리 주소로 변환이 일어날 때마다 시행
- 메모리 접근 권한에 맞지 않는 접근이 일어날 경우 트랩이 발생
- 페이지 테이블, 세그먼테이션 테이블에는 이러한 메모리 접근 권한에 대한 정보를 비트로 가지고 있으며 주소 변환이 일어날 때마다 유용한 접근인지 아닌지 검사한다.

### 세그먼테이션-페이징 혼용 도입

- 페이지 테이블마다 권한 비트가 추가되면 페이지 테이블의 크기가 커진다.
- 관련있는 메모리 영역은 권한 비트가 중복되는 영역이 많으므로 서로 관련있는 영역을 하나의 세그먼트로 묶어 세그먼트 테이블로 관리하고,  
각 세그먼트를 구성하는 페이지를 해당 페이지 테이블로 관리하는 방식이다.
- 세그먼트 테이블에는 해당 페이지 테이블의 시작 주소가 기록되어 있다.
- 세그먼테이션 테이블에서는 오류가 없는지(영역을 벗어나진 않는지), 접근 권한을 가지고 있는지 확인한다.


## 📌 [심화] 캐시 매핑 기법

### 캐시 직접 매핑

- 메인메모리의 페이지가 정해진 위치에만 들어갈 수 있다.
- 캐시 크기(블록)으로 메모리를 나눠준 후 블록을 구성하는 페이지는 캐시내에서 블록내에서의 같은 위치에만 캐시에 올라올 수 있다.
- 블록 내 첫 번째 페이지는 캐시의 첫 번째 페이지로 블록 내 두 번째 페이지는 캐시의 두 번째 페이지로만 올라온다.
- 블록 번호는 태그이다.

### 캐시 연관 매핑

- 메모리 워드가 캐시의 어느 위치에도 자유롭게 올라갈 수 있음
- 캐시 히트인지, 캐시 미스인지 확인하기 위해 캐시의 모든 주소를 검색해야 한다.
- 연관 매핑은 직접 매핑보다 느리다.

### 캐시 집합-연관 매핑

- 캐시를 K개의 집합으로 나누고 각 집합에 직접 매핑을 사용하는 방식

