
# 📚 로드 밸런서

## 📌 부하 분산이란?

### 로드 밸런서 (L4 스위치, L7 스위치)

- 동일한 서비스를 하는 다수의 서버가 등록되고 사용자로부터 서비스 요청이 오면 로드 밸런서가 받아 사용자별로  
다수의 서버에 서비스 요청을 분산시켜 부하를 분산.
- 서비스를 위한 가상 IP(VIP)를 하나 제공 => 가상 IP를 통해 각 서버로 접근

## 📌 부하 분산 방법

### 가상 IP, 리얼 IP

- 가상 IP(VIP) : 로드밸런서가 같는 가상 IP 주소
- 리얼 IP(RIP) : 각 서버의 실제 IP 주소

## 📌 헬스 체크

### 헬스 체크

- 로드 밸런서는 부하 분산을 하는 각 서버의 서비스를 주기적으로 헬스 체크해 정상적인 서비스 쪽으로만 부하를 분산

### 헬스 체크 방식

- ICMP(ping) => 리얼 서버에 대해 ICMP로 헬스 체크를 수행 => 단순히 서버만 살아 잇는지 여부만 체크
- TCP 서비스 포트
- TCP 서비스 포트 (TCP Half Open, 절반개방)
- HTTP 상태 코드 => TCP로 정상적으로 열리지만 웹 서비스에 대한 응답을 해주지 못할 때 사용 => HTTP를 요청해 상태 코드(200 OK)여부 확인
- 콘텐츠 확인(문자열 확인) => 특정 웹페이지를 호출해 사전에 지정한 문자열이 해당 웹페이지 내에 포함되어 있는지 체크

### 헬스 체크 주기와 타이머

- 주기(Interval) => 로드 밸런서에서 서버로 헬스 체크 패킷을 보내는 주기
- 응답 시간(Response) => 서버로 헬스 체크 패킷을 보내고 응답을 기다리는 시간
- 시도 횟수(Retries) => 헬스 체크 실패 시 최대 시도 횟수
- 타임 아웃(Timeout) => 헬스 체크 실패 시 최대 대기 시간
- 서비스 다운 시의 주기(Dead Interval) => 서비스 다운 시의 헬스 체크 주기

## 📌 부하 분산 알고리즘

### 부하 분산 알고리즘 종류

- 라운드 로빈(Round Robin) => 현재 구성된 장비에 부하를 순차적으로 분산
- 최소 접속 방식(Least Connection) => 현재 구성된 장비 중 가장 활성화된 세션 수가 적은 장비로 분산
- 가중치 기반 라운드 로빈(Weighted Round Robin) => 각 장비에 가중치를 두어 가중치가 높은 장비에 부하를 더 많이 분산 + 라운드 로빈
- 가중치 기반 최소 접속 방식 => 가중치 + 최소 접속 방식
- 해시(Hash) => 해시 알고리즘을 이용한 부하 분산 => 같은 서버에 지속적으로 접속하기 위해
 
## 📌 로드 밸런서 구성 방식

### 로드밸런서 2가지 구성 방식 

- 원암(One-Arm) 구성 => 중간 스위치 옆에 연결되는 구성
- 인라인(Inline) 구성 => 서버로 가는 경로상에 로드 밸런서가 연결되는 구성
- 실질적으로 원암과 인라인의 구분은 서버로 가는 트래픽이 모드 로드 밸런서를 경유하는지 아닌지에 대한 트래픽 흐름으로 구분

## 📌 로드 밸런서 동작 모드

### 로드 밸런서 동작 방식 3가지

- 트랜스패런트(Transparent: TP) 또는 브릿지(Bridge)
- 라우티드(Routed)
- DSR(Direct Server Return)

### 트랜스패런트 모드 (Transparent Mode)

- 로드밸런서가 OSI 2계층 스위치처럼 동작하는 구성
- VIP 주소와 실제 서버가 동일한 네트워크를 사용
- 원암, 인라인 구성에서 사용

### 라우티드 모드 (Routed Mode)

- 로드 밸런서가 라우팅 역할을 수행하는 모드
- 원암, 인라인 구성에서 사용
- 보안 강화 목적으로도 사용

### DSR 모드 (Direct Server Return Mode)

- 사용자의 요청이 로드 밸런서를 통해 서버로 유입된 후에 다시 로드 밸런서를 통하지 않고 서버가 사용자에게 직접 응답하는 모드
- 로드 블랜서는 응답 트래픽이 유입되지 않으므로 사용자가 요청한 패킷에 대해서만 관여
- 원암 구성에서 사용 
- 인라인 (X) => 응답 트래픽에서는 경유하지 않음
- 서비스 응답이 로드 밸런서를 경유하지 않으므로 문제 발생 시, 문제 확인이 어렵다
- 서버에서도 추가 설정 필요 => 서버에 루프백 인터페이스를 생성해 VIP 주소를 할당

## 📌 로드 밸런서 유의사항

### 원암 구성의 동일 네트워크 사용 시 p.509

- 로드 밸런서를 바로 거치지 않고 사용자에게 바로 응답 시, 요청하지 않은 IP에서 패킷을 받으므로 폐기
    - 해결방법
    1. 게이트웨이를 로드 밸런서로 설정
    2. Source NAT 사용
    3. DSR 모드

### 동일 네트워크 내에서 서비스 IP(VIP) 호출 p.512

- 로드 밸런서에 구성된 서버 1이 로드 밸런서를 통해 서버 2의 서비스를 요청 했으나, 서버 2가 로드밸런서를 경유하지 않고 서버 1로 응답 
    - 해결방법
    1. Source NAT
    2. DST 모드
- 원암, 인라인에서 발생


## 📌 HAProxy를 사용한 로드 밸런서 설정

### HAProxy
- 오픈 소스 기반의 소프트웨어 로드 밸런서
- 일종의 NFV
- 가상화나 클라우드 환경에서 적합
- 개발 환경에서 별도의 로드 밸런서 장비 없이 부하 분산 및 이중화 테스트에 쉽게 사용 가능

